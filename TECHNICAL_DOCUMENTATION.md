# Τεκμηρίωση Προσαρμοσμένων Λιστών & Καταλόγων

Αυτό το έγγραφο εξηγεί τη δομή και τη λειτουργία του συστήματος διαχείρισης προσαρμοσμένων λιστών και σύνθετων οντοτήτων της εφαρμογής.

## 1. Επισκόπηση

Το σύστημα επιτρέπει τη δυναμική δημιουργία και διαχείριση δύο τύπων δεδομένων:
1.  **Απλές Λίστες (Simple Lists):** Χρησιμοποιούνται για τη δημιουργία αναπτυσσόμενων μενού (dropdowns) σε όλη την εφαρμογή, όπως λίστες με "Ρόλους", "Ειδικότητες", "Κατηγορίες Παρεμβάσεων" κ.λπ.
2.  **Σύνθετες Οντότητες (Complex Entities):** Χρησιμοποιούνται για τη δημιουργία καταλόγων με πιο δομημένα δεδομένα, όπως ένας κατάλογος με "Αστυνομικά Τμήματα" που περιλαμβάνει διεύθυνση, τηλέφωνο κ.λπ.

Η διαχείριση γίνεται από τη σελίδα `/custom-lists`.

## 2. Δομή Δεδομένων στο Firestore

Τα δεδομένα αποθηκεύονται σε δύο διαφορετικές συλλογές (collections) στο Firestore.

---

### 2.1 Απλές Λίστες

Οι απλές λίστες αποθηκεύονται στη συλλογή `tsia-custom-lists`.

#### Δομή Εγγράφου Λίστας (List Document)

Κάθε έγγραφο σε αυτή τη συλλογή αντιπροσωπεύει μια λίστα.

*   **Collection:** `tsia-custom-lists`
*   **Document ID:** (Αυτόματο ID από το Firestore)

**Πεδία:**
| Πεδίο | Τύπος | Περιγραφή |
| :--- | :--- | :--- |
| `title` | `string`| Ο τίτλος της λίστας που εμφανίζεται στο UI (π.χ., "Ρόλοι"). |
| `description` | `string`| (Προαιρετικό) Μια σύντομη περιγραφή για το σκοπό της λίστας. |
| `hasCode` | `boolean`| (Προαιρετικό) Αν είναι `true`, κάθε στοιχείο της λίστας μπορεί να έχει και έναν κωδικό εκτός από την τιμή του. |
| `isProtected`| `boolean`| (Προαιρετικό) Αν είναι `true`, η λίστα δεν μπορεί να διαγραφεί από το UI (χρήσιμο για βασικές λίστες του συστήματος). |
| `createdAt` | `Timestamp`| Ημερομηνία δημιουργίας. |

#### Δομή Στοιχείου Λίστας (List Item)

Κάθε λίστα περιέχει μια υπο-συλλογή (subcollection) με όνομα `tsia-items` που περιέχει τα στοιχεία της.

*   **Subcollection:** `tsia-custom-lists/{listId}/tsia-items`
*   **Document ID:** (Αυτόματο ID από το Firestore)

**Πεδία:**
| Πεδίο | Τύπος | Περιγραφή |
| :--- | :--- | :--- |
| `value` | `string`| Η κύρια τιμή/ετικέτα του στοιχείου (π.χ., "Πελάτης"). |
| `code` | `string`| (Προαιρετικό) Ένας μοναδικός κωδικός για το στοιχείο (π.χ., "3.Α"). Χρησιμοποιείται μόνο αν το `hasCode` της λίστας είναι `true`.|
| `createdAt`| `Timestamp`| Ημερομηνία δημιουργίας. |

**Παράδειγμα (ΔΟΥ):**
Μια λίστα "Δημόσιες Οικονομικές Υπηρεσίες" με `hasCode: true`.
Ένα στοιχείο σε αυτή τη λίστα θα ήταν:
- `code`: "1118"
- `value`: "ΔΟΥ ΚΑΛΑΜΑΡΙΑΣ"

---

### 2.2 Σύνθετες Οντότητες

Οι σύνθετες οντότητες αποθηκεύονται στην κορυφαίου επιπέδου συλλογή `tsia-complex-entities`.

#### Δομή Εγγράφου Οντότητας (Entity Document)

*   **Collection:** `tsia-complex-entities`
*   **Document ID:** (Αυτόματο ID από το Firestore)

**Πεδία:**
| Πεδίο | Τύπος | Περιγραφή |
| :--- | :--- | :--- |
| `type` | `string`| Ο τύπος της οντότητας. Χρησιμοποιείται για την ομαδοποίηση (π.χ., "policeStation"). |
| `name` | `string`| Το κύριο όνομα της οντότητας (π.χ., "Α.Τ. Κορδελιού-Ευόσμου"). |
| `address` | `string`| (Προαιρετικό) Η διεύθυνση. |
| `phone` | `string`| (Προαιρετικό) Το τηλέφωνο. |
| `region` | `string`| (Προαιρετικό) Ο νομός/περιοχή. |
| `email` | `string`| (Προαιρετικό) Το email. |
| `website` | `string`| (Προαιρετικό) Η ιστοσελίδα. |
| `notes` | `string`| (Προαιρετικό) Ελεύθερες σημειώσεις. |
| `createdAt`| `Timestamp`| Ημερομηνία δημιουργίας. |

## 3. Λειτουργία στον Κώδικα (CRUD)

Η κύρια λογική βρίσκεται στον φάκελο `src/features/custom-lists`.

### Hooks

-   **`useCustomLists.ts`**: Διαχειρίζεται τις απλές λίστες. Παρέχει listeners (onSnapshot) στο Firestore και φέρνει όλες τις λίστες και τα στοιχεία τους σε πραγματικό χρόνο. Παρέχει επίσης τις συναρτήσεις `createList`, `updateList`, `deleteList`, `addItem`, `updateItem`, και `deleteItem` για την εκτέλεση όλων των CRUD λειτουργιών.
-   **`useComplexEntities.ts`**: Διαχειρίζεται τις σύνθετες οντότητες. Παρέχει CRUD λειτουργίες για αυτές τις οντότητες, φιλτραρισμένες ανά `type`.

### Components

-   **`SimpleListsTab.tsx`**: Το κύριο component για την καρτέλα "Απλές Λίστες". Χρησιμοποιεί το `useCustomLists` και συνθέτει τα υπόλοιπα components για την εμφάνιση και διαχείριση.
-   **`ComplexEntitiesTab.tsx`**: Το κύριο component για την καρτέλα "Σύνθετες Οντότητες". Χρησιμοποιεί το `useComplexEntities`.
-   **`EditableList.tsx`**: Ένα επαναχρησιμοποιήσιμο component τύπου "accordion" που εμφανίζει μια λίστα και τα στοιχεία της, επιτρέποντας την προσθήκη, επεξεργασία και διαγραφή.
-   **`ListItem.tsx`**: Το component που αναλαμβάνει την εμφάνιση και την "in-line" επεξεργασία κάθε μεμονωμένου στοιχείου της λίστας.

## 4. Αρχικές Λίστες Δεδομένων

Οι παρακάτω λίστες είναι παραδείγματα που μπορεί να υπάρχουν στην εφαρμογή:

-   **Ρόλοι** (Απλή Λίστα): Πελάτης, Συνεργάτης, Προμηθευτής, Μηχανικός.
-   **Ειδικότητες** (Απλή Λίστα): Ιδιώτης, Πολιτικός Μηχανικός, Υδραυλικός, Ηλεκτρολόγος.
-   **Κατηγορία Παρέμβασης** (Απλή Λίστα): Αντλίες θερμότητας, Ηλιακός, Μόνωση, Κουφώματα.
-   **Δημόσιες Οικονομικές Υπηρεσίες** (Απλή Λίστα με Κωδικό):
    -   Κωδικός: 1118, Τιμή: ΔΟΥ ΚΑΛΑΜΑΡΙΑΣ
    -   Κωδικός: 1119, Τιμή: ΔΟΥ ΑΜΠΕΛΟΚΗΠΩΝ
-   **Αστυνομικά Τμήματα** (Σύνθετη Οντότητα, type: 'policeStation'):
    -   Όνομα: Α.Τ. Λευκού Πύργου
    -   Διεύθυνση: Υπ. Αστυν. Γεωργιάδη 2, 54621 Θεσσαλονίκη
    -   Τηλέφωνο: 2310257770

## 5. Μαζική Προσθήκη Στοιχείων (Bulk Add)

Το πεδίο εισαγωγής (`Textarea`) σε κάθε λίστα υποστηρίζει μαζική προσθήκη στοιχείων για ταχύτητα και ευκολία. Η λογική προσαρμόζεται ανάλογα με το αν η λίστα έχει κωδικούς (`hasCode: true`) ή όχι.

### 5.1 Λίστες ΧΩΡΙΣ Κωδικό

Για απλές λίστες, ο χρήστης μπορεί να εισάγει πολλαπλά στοιχεία ταυτόχρονα, διαχωρίζοντάς τα με έναν από τους παρακάτω χαρακτήρες:
-   Ερωτηματικό (`;`)
-   Αλλαγή γραμμής (Enter)
-   Tab

**Παράδειγμα:**
Ο χρήστης μπορεί να επικολλήσει το παρακάτω κείμενο στο πεδίο:
`Υδραυλικός;Ηλεκτρολόγος	Ελαιοχρωματιστής`
`Τεχνίτης Μόνωσης`

Το σύστημα θα δημιουργήσει αυτόματα τέσσερις ξεχωριστές εγγραφές: "Υδραυλικός", "Ηλεκτρολόγος", "Ελαιοχρωματιστής" και "Τεχνίτης Μόνωσης".
Ο κώδικας αφαιρεί αυτόματα τα κενά στην αρχή και το τέλος κάθε στοιχείου και αποτρέπει τη δημιουργία διπλότυπων (case-insensitive).

### 5.2 Λίστες ΜΕ Κωδικό (`hasCode: true`)

Για τις λίστες που απαιτούν κωδικό, η μαζική εισαγωγή γίνεται με τη μορφή:
`ΚΩΔΙΚΟΣ [κενό] ΟΝΟΜΑ`

Κάθε ζεύγος κωδικού-ονόματος πρέπει να βρίσκεται σε **ξεχωριστή γραμμή**. Το σύστημα χρησιμοποιεί το **πρώτο κενό** ως διαχωριστικό μεταξύ του κωδικού και της τιμής.

**Παράδειγμα:**
Για να προσθέσει μαζικά Δ.Ο.Υ., ο χρήστης μπορεί να επικολλήσει το παρακάτω, συνήθως από ένα αρχείο Excel:
```
1118 ΔΟΥ ΚΑΛΑΜΑΡΙΑΣ
1119 ΔΟΥ ΑΜΠΕΛΟΚΗΠΩΝ ΘΕΣ/ΝΙΚΗΣ
1120 ΔΟΥ Α' ΘΕΣΣΑΛΟΝΙΚΗΣ
```
Το σύστημα θα δημιουργήσει τρεις εγγραφές, συνδέοντας σωστά τον κωδικό με την τιμή του. Η λογική αποτρέπει τη δημιουργία διπλότυπων με βάση τον κωδικό.

### Απόσπασμα Κώδικα (από `useCustomLists.ts`)

Η παρακάτω συνάρτηση `addItem` περιέχει τη λογική επεξεργασίας:

```typescript
// ...μέσα στο hook useCustomLists
const addItem = useCallback(async (listId: string, itemData: { value: string; code?: string }) => {
    // ... αρχικός κώδικας ελέγχου ...
    const list = lists.find(l => l.id === listId);
    if (!list) throw new Error("List not found.");

    let itemsToAdd: { value: string; code?: string; }[] = [];

    if (list.hasCode) {
        // Λογική για λίστες με κωδικό
        const lines = rawValue.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        // ... επεξεργασία κάθε γραμμής για ΚΩΔΙΚΟ και ΟΝΟΜΑ ...
    } else {
        // Λογική για απλές λίστες
        const values = rawValue.split(/[;\n\r\t]+/).map(v => v.trim()).filter(Boolean);
        // ... διαχείριση διπλοτύπων και δημιουργία λίστας ...
    }
    
    // ... κώδικας για την εγγραφή των νέων στοιχείων στη βάση (batch write) ...
}, [lists, toast]);
```

## 6. Επεξεργασία & Διαγραφή Στοιχείων

Η διαχείριση των μεμονωμένων στοιχείων μέσα σε μια λίστα είναι σχεδιασμένη για ευκολία και ασφάλεια.

### 6.1 Επεξεργασία (In-line Editing)

- **Αλληλεπίδραση:** Όταν ο χρήστης περνάει το ποντίκι πάνω από ένα στοιχείο, εμφανίζονται τα εικονίδια της επεξεργασίας (μολύβι) και της διαγραφής (κάδος).
- **Διαδικασία:** Πατώντας το μολύβι, το κείμενο του στοιχείου μετατρέπεται σε πεδίο εισαγωγής (`<Input>`). Ο χρήστης μπορεί να αλλάξει την τιμή (και τον κωδικό, αν υπάρχει) απευθείας.
- **Αποθήκευση:** Η αλλαγή αποθηκεύεται αυτόματα όταν ο χρήστης πατήσει `Enter` ή όταν κάνει κλικ εκτός του πεδίου (on blur). Η ενέργεια μπορεί να ακυρωθεί πατώντας `Escape`.
- **Υλοποίηση:** Αυτή η λειτουργία ελέγχεται από το component `src/features/custom-lists/components/ListItem.tsx`, το οποίο καλεί τη συνάρτηση `updateItem` του hook `useCustomLists`.

### 6.2 Διαγραφή και Έλεγχος Εξαρτήσεων

Για την προστασία της ακεραιότητας των δεδομένων, η εφαρμογή αποτρέπει τη διαγραφή στοιχείων που χρησιμοποιούνται.

- **Διαδικασία:** Όταν ο χρήστης πατάει το εικονίδιο του κάδου, καλείται η συνάρτηση `deleteItem` από το hook `useCustomLists`.
- **Έλεγχος Εξάρτησης (Dependency Check):** Πριν διαγράψει το στοιχείο από το Firestore, η συνάρτηση εκτελεί έναν κρίσιμο έλεγχο:
  1.  Αναγνωρίζει σε ποιο πεδίο των επαφών αντιστοιχεί η λίστα (π.χ., η λίστα "Ρόλοι" αντιστοιχεί στο πεδίο `job.role` των επαφών).
  2.  Εκτελεί ένα query στη συλλογή `tsia-contacts` για να δει αν **έστω και μία επαφή** χρησιμοποιεί την τιμή που πάει να διαγραφεί.
- **Αποτέλεσμα:**
  -   **Αν ΔΕΝ βρεθεί εξάρτηση:** Το στοιχείο διαγράφεται κανονικά από το Firestore.
  -   **Αν βρεθεί έστω και μία εξάρτηση:** Η διαγραφή **ακυρώνεται** και εμφανίζεται ένα μήνυμα σφάλματος (toast) που ενημερώνει τον χρήστη για το ποια επαφή χρησιμοποιεί το συγκεκριμένο στοιχείο.
```typescript
// Απόσπασμα από το useCustomLists.ts
const deleteItem = useCallback(async (listId: string, itemId: string, itemValue: string): Promise<boolean> => {
    // ...
    const list = lists.find(l => l.id === listId);
    const contactField = listToContactFieldMap[list.title]; // e.g., 'job.role'
    
    if (contactField) {
        // Query to check if any contact uses this itemValue
        const q = query(collection(db, 'tsia-contacts'), where(contactField, '==', itemValue), limit(1));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
            // Αν βρεθεί, ακύρωσε τη διαγραφή και δείξε μήνυμα
            const contactInUse = snapshot.docs[0].data();
            toast({
                variant: 'destructive',
                title: "Αδυναμία Διαγραφής",
                description: `Το στοιχείο "${itemValue}" χρησιμοποιείται από την επαφή: ${contactInUse.name}.`
            });
            return false;
        }
    }
    
    // Αν δεν υπάρχουν εξαρτήσεις, προχώρα στη διαγραφή...
    await deleteDoc(doc(db, 'tsia-custom-lists', listId, 'tsia-items', itemId));
    return true;
}, [lists, toast]);
```
Αυτός ο μηχανισμός διασφαλίζει ότι δεν θα διαγραφούν κατά λάθος τιμές που είναι κρίσιμες για την καταχώρηση δεδομένων σε άλλα μέρη της εφαρμογής.

## 7. Εξαγωγή Δεδομένων

Η εφαρμογή υποστηρίζει την εξαγωγή των δεδομένων από τις λίστες σε μορφή CSV (για Excel) και απλού κειμένου (TXT).

- **Υλοποίηση:** Τα κουμπιά εξαγωγής βρίσκονται στα components `SimpleListsTab.tsx` και `ComplexEntitiesTab.tsx`.
- **Λογική:** Όταν ο χρήστης πατάει ένα κουμπί εξαγωγής:
  1.  Τα δεδομένα από τις ορατές (φιλτραρισμένες) λίστες συγκεντρώνονται.
  2.  Καλούνται οι βοηθητικές συναρτήσεις `exportToCsv` ή `exportToTxt` από το αρχείο `src/lib/exportUtils.ts`.
  3.  **Για CSV:** Τα δεδομένα μετατρέπονται σε ένα string, με κάθε πεδίο να διαχωρίζεται με ερωτηματικό (`;`) για σωστή απεικόνιση στο ελληνικό Excel.
  4.  **Για TXT:** Τα δεδομένα μορφοποιούνται σε μια ευανάγνωστη δομή κειμένου.
  5.  Ο κώδικας δημιουργεί ένα `Blob` (ένα αντικείμενο τύπου αρχείου) και στη συνέχεια προσομοιώνει ένα κλικ σε έναν κρυφό σύνδεσμο (`<a>`) για να ξεκινήσει το κατέβασμα του αρχείου στον browser του χρήστη.
```typescript
// Απόσπασμα από το exportUtils.ts

const convertToCsv = (data: any[]): string => {
    // ... Λογική για τη μετατροπή του JSON array σε CSV string με ;
    const headers = Object.keys(data[0]);
    const rows = data.map(obj => 
        headers.map(header => JSON.stringify(obj[header] || '')).join(';')
    );
    return [headers.join(';'), ...rows].join('\n');
};

const triggerDownload = (blob: Blob, filename: string) => {
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};
```
