# =========================
#  Œ†œéœÇ ŒΩŒ± œÑœÅŒ≠ŒæŒµŒπœÇ Œ±œÖœÑœå œÑŒø script:
#
#   bash project-check.sh
#
# (ŒëŒΩ Œ≤Œ≥Œ¨ŒªŒµŒπ Permission Denied, œÄœÅœéœÑŒ± œÑœÅŒ≠ŒæŒµ:
#   chmod +x project-check.sh
# Œ∫Œ±Œπ ŒºŒµœÑŒ¨:
#   ./project-check.sh
# )
#
# Firebase Studio Terminal friendly!
# =========================

#!/usr/bin/env bash

set -e

# Cleanup function
cleanup() {
  echo "üßπ Cleaning up processes..." | tee -a project-check.log
  kill $DEV_PID $PREVIEW_PID $EMULATOR_PID 2>/dev/null || true
}
trap cleanup EXIT

echo "ŒûŒµŒ∫ŒØŒΩŒ∑œÉŒµ: $(date)" | tee -a project-check.log

echo "üö¶ 0.0 Checking required environment variables..." | tee -a project-check.log
REQUIRED_VARS=() # ŒëœÜŒ±ŒπœÅŒ≠Œ∏Œ∑Œ∫Œµ Œø Œ≠ŒªŒµŒ≥œáŒøœÇ Œ≥ŒπŒ± NEXT_PUBLIC_API_URL
for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    echo "‚ùå Missing env variable: $var" | tee -a project-check.log
    exit 1
  fi
done
echo "‚úÖ Env variables look ok." | tee -a project-check.log

echo "üö¶ 0.1 Checking environment files consistency..." | tee -a project-check.log
ENV_FILES=("***REMOVED***.local" "***REMOVED***.development" "***REMOVED***.production")
for env_file in "${ENV_FILES[@]}"; do
  if [ -f "$env_file" ]; then
    echo "‚ÑπÔ∏è  Found $env_file - checking for required keys..." | tee -a project-check.log
    # ŒàŒªŒµŒ≥œáŒøœÇ Œ≥ŒπŒ± Œ∫ŒµŒΩŒ≠œÇ Œ≥œÅŒ±ŒºŒºŒ≠œÇ ŒÆ ŒªŒ¨Œ∏ŒøœÇ format
    if grep -q "^[^#]*=" "$env_file"; then
      echo "‚úÖ $env_file contains environment variables." | tee -a project-check.log
    fi
  fi
done

echo "üö¶ 0.2 Checking for security vulnerabilities..." | tee -a project-check.log
if npm audit --audit-level high 2>/dev/null | grep -q "found.*vulnerabilities"; then
  echo "‚ö†Ô∏è  High severity vulnerabilities found! Run 'npm audit fix'" | tee -a project-check.log
else
  echo "‚úÖ No high severity vulnerabilities found." | tee -a project-check.log
fi

echo "üö¶ 0.3 Checking Firebase configuration..." | tee -a project-check.log
if [ ! -f firebase.json ]; then
  echo "‚ùå Missing firebase.json file!" | tee -a project-check.log
  exit 1
fi
if [ ! -f .firebaserc ]; then
  echo "‚ùå Missing .firebaserc file!" | tee -a project-check.log
  exit 1
fi
if ! command -v firebase >/dev/null 2>&1; then
  echo "‚ùå Firebase CLI is not installed!" | tee -a project-check.log
  exit 1
fi
FIREBASE_VERSION=$(firebase --version)
echo "‚úÖ Firebase CLI version: $FIREBASE_VERSION" | tee -a project-check.log
echo "‚úÖ Firebase configuration files found." | tee -a project-check.log

echo "üö¶ 0.4 Checking .gitignore and sensitive files..." | tee -a project-check.log
if [ ! -f .gitignore ]; then
  echo "‚ùå Missing .gitignore file!" | tee -a project-check.log
  exit 1
fi
if grep -q "***REMOVED***" .gitignore && git ls-files | grep -q "***REMOVED***"; then
  echo "‚ùå Sensitive ***REMOVED*** file found in git index!" | tee -a project-check.log
  exit 1
fi
echo "‚úÖ .gitignore and sensitive files check passed." | tee -a project-check.log

echo "üö¶ 0.5 Checking for uncommitted changes..." | tee -a project-check.log
if [ -n "$(git status --porcelain)" ]; then
  echo "‚ö†Ô∏è  Œ•œÄŒ¨œÅœáŒøœÖŒΩ uncommitted changes! ŒöŒ±Œªœå ŒµŒØŒΩŒ±Œπ ŒΩŒ± œÑŒ± commitŒ¨œÅŒµŒπœÇ œÄœÅŒπŒΩ œÉœÖŒΩŒµœáŒØœÉŒµŒπœÇ." | tee -a project-check.log
fi

echo "üö¶ 0.6 Checking for outdated dependencies..." | tee -a project-check.log
if npm outdated | grep -q 'Package'; then
  echo "‚ö†Ô∏è  Œ•œÄŒ¨œÅœáŒøœÖŒΩ outdated dependencies! (Œ†œÅŒøŒ±ŒπœÅŒµœÑŒπŒ∫œå) ŒîŒµœÇ œÑŒ± œÄŒ±œÅŒ±œÄŒ¨ŒΩœâ Œ∫Œ±Œπ œÉŒ∫Œ≠œàŒøœÖ Œ±ŒΩ œÄœÅŒ≠œÄŒµŒπ ŒΩŒ± œÑŒ± ŒµŒΩŒ∑ŒºŒµœÅœéœÉŒµŒπœÇ." | tee -a project-check.log
else
  echo "‚úÖ No outdated dependencies found." | tee -a project-check.log
fi

echo "üö¶ 1. Linting code (npm run lint)..." | tee -a project-check.log
if ! npm run lint; then
  echo "‚ùå Linting failed. ŒîŒπœåœÅŒ∏œâœÉŒµ œÑŒ± lint errors œÄœÅŒπŒΩ œÉœÖŒΩŒµœáŒØœÉŒµŒπœÇ!" | tee -a project-check.log
  exit 1
fi
echo "‚úÖ Linting passed." | tee -a project-check.log

echo "üö¶ 1.1 Checking code formatting (prettier --check)..." | tee -a project-check.log
if [ -f package.json ] && grep -q "\"format\":" package.json; then
  if ! npm run format:check; then
    echo "‚ùå Formatting failed. Œ§œÅŒ≠ŒæŒµ 'npm run format' Œ≥ŒπŒ± ŒΩŒ± Œ¥ŒπŒøœÅŒ∏œéœÉŒµŒπœÇ." | tee -a project-check.log
    exit 1
  fi
  echo "‚úÖ Formatting OK." | tee -a project-check.log
elif npx prettier --check .; then
  echo "‚úÖ Formatting OK (prettier --check)." | tee -a project-check.log
else
  echo "‚ùå Formatting failed. Œ§œÅŒ≠ŒæŒµ 'npx prettier --write .' Œ≥ŒπŒ± ŒΩŒ± Œ¥ŒπŒøœÅŒ∏œéœÉŒµŒπœÇ." | tee -a project-check.log
  exit 1
fi

echo "üö¶ 2. Type checking (tsc --noEmit)..." | tee -a project-check.log
if ! npx tsc --noEmit; then
  echo "‚ùå TypeScript type check failed. ŒîŒπœåœÅŒ∏œâœÉŒµ œÑŒ± type errors œÄœÅŒπŒΩ œÉœÖŒΩŒµœáŒØœÉŒµŒπœÇ!" | tee -a project-check.log
  exit 1
fi
echo "‚úÖ TypeScript types are valid." | tee -a project-check.log

echo "üö¶ 2.1 Checking Firebase Emulator Suite..." | tee -a project-check.log
if firebase emulators:start --only firestore,functions --inspect-functions &>/tmp/emulator.log & then
  EMULATOR_PID=$!
  sleep 10
  if timeout 30 curl --silent --fail http://localhost:8080 >/dev/null; then
    echo "‚úÖ Firestore emulator responds!" | tee -a project-check.log
  else
    echo "‚ùå Firestore emulator failed to respond!" | tee -a project-check.log
    kill $EMULATOR_PID || true
    exit 1
  fi
  kill $EMULATOR_PID || true
else
  echo "‚ùå Failed to start Firebase emulators!" | tee -a project-check.log
  exit 1
fi

echo "üö¶ 2.2 Validating Firebase Security Rules..." | tee -a project-check.log
if [ -f firestore.rules ]; then
  if ! firebase firestore:rules:validate; then
    echo "‚ùå Firestore rules validation failed!" | tee -a project-check.log
    exit 1
  fi
  echo "‚úÖ Firestore security rules are valid." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  No firestore.rules file found, skipping validation." | tee -a project-check.log
fi

echo "üö¶ 2.3 Checking Firestore indexes..." | tee -a project-check.log
if [ -f firestore.indexes.json ]; then
  echo "‚ÑπÔ∏è  Found firestore.indexes.json - make sure indexes are deployed in production." | tee -a project-check.log
  echo "‚úÖ Firestore indexes file found." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  No firestore.indexes.json found." | tee -a project-check.log
fi

echo "üö¶ 2.4 Checking Firebase Functions..." | tee -a project-check.log
if [ -d "functions" ]; then
  cd functions
  if ! npm run build 2>/dev/null; then
    echo "‚ùå Functions build failed!" | tee -a project-check.log
    cd ..
    exit 1
  fi
  cd ..
  echo "‚úÖ Firebase Functions build OK." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  No functions directory found, skipping." | tee -a project-check.log
fi

echo "üö¶ 3. Running development server (npm run dev)..." | tee -a project-check.log
npm run dev &
DEV_PID=$!
sleep 10

echo "üîç Checking if dev server responds at http://localhost:9003..." | tee -a project-check.log
if timeout 30 curl --silent --fail http://localhost:9003 >/dev/null; then
  echo "‚úÖ Dev server responds!" | tee -a project-check.log
else
  echo "‚ùå Dev server ŒîŒïŒù Œ±œÄŒ±ŒΩœÑŒ¨ŒµŒπ! ŒöŒ¨œÑŒπ œÑœÅŒ≠œáŒµŒπ..." | tee -a project-check.log
  kill $DEV_PID || true
  exit 1
fi

echo "üö¶ 3.1 Running E2E tests (npm run e2e)..." | tee -a project-check.log
if [ -f package.json ] && grep -q "\"e2e\":" package.json; then
  if ! npm run e2e; then
    echo "‚ùå E2E tests failed. ŒîŒπœåœÅŒ∏œâœÉŒµ œÑŒ± œÉœÜŒ¨ŒªŒºŒ±œÑŒ±!" | tee -a project-check.log
    kill $DEV_PID || true
    exit 1
  fi
  echo "‚úÖ E2E tests passed." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ E2E tests, œÄœÅŒøœáœâœÅŒ¨ŒºŒµ." | tee -a project-check.log
fi

echo "üö¶ 3.2 Testing critical API endpoints..." | tee -a project-check.log
CRITICAL_ENDPOINTS=("/api/health" "/api/auth/status")
for endpoint in "${CRITICAL_ENDPOINTS[@]}"; do
  if timeout 10 curl --silent --fail "http://localhost:9003$endpoint" >/dev/null; then
    echo "‚úÖ $endpoint responds" | tee -a project-check.log
  else
    echo "‚ÑπÔ∏è  $endpoint not responding (might be expected)" | tee -a project-check.log
  fi
done

echo "üö¶ 3.3 Manual testing required..." | tee -a project-check.log
echo "‚ÑπÔ∏è  ŒïŒªŒµŒ≥ŒæŒµ MANUAL œÉœÑŒøŒΩ browser œÉŒøœÖ Œ±ŒΩ œÜŒøœÅœÑœéŒΩŒµŒπ œÉœâœÉœÑŒ¨ œÉœÑŒø http://localhost:9003" | tee -a project-check.log
echo "‚ÑπÔ∏è  ŒÜŒΩŒøŒπŒæŒµ œÑŒ± Developer Tools Œ∫Œ±Œπ Œ¥ŒµœÇ Œ±ŒΩ œÖœÄŒ¨œÅœáŒøœÖŒΩ errors œÉœÑŒø console" | tee -a project-check.log
echo "‚ÑπÔ∏è  ŒöœåŒ∫Œ∫ŒπŒΩŒ± errors = œÄœÅœåŒ≤ŒªŒ∑ŒºŒ±, Œ∫ŒØœÑœÅŒπŒΩŒ± warnings = œÄœÅŒøœÉŒøœáŒÆ" | tee -a project-check.log
echo "‚ÑπÔ∏è  Œ†Œ¨œÑŒ∑œÉŒµ Enter œåœÑŒ±ŒΩ œÑŒµŒªŒµŒπœéœÉŒµŒπœÇ œÑŒø manual test (ŒÆ Ctrl+C Œ≥ŒπŒ± ŒΩŒ± œÑŒø Œ¥ŒπŒ±Œ∫œåœàŒµŒπœÇ Œ±ŒΩ Œ∫Œ¨œÑŒπ œÄŒ¨ŒµŒπ œÉœÑœÅŒ±Œ≤Œ¨)" | tee -a project-check.log
read -p "‚Ü©Ô∏è "

kill $DEV_PID || true
sleep 2

echo "üö¶ 4. Building production build (npm run build)..." | tee -a project-check.log
if ! npm run build; then
  echo "‚ùå Production build failed. ŒîŒπœåœÅŒ∏œâœÉŒµ œÑŒ± build errors!" | tee -a project-check.log
  exit 1
fi
echo "‚úÖ Build passed." | tee -a project-check.log

echo "üö¶ 4.1 Checking production build size..." | tee -a project-check.log
MAX_SIZE=$((2 * 1024 * 1024)) # 2MB in bytes
BUILD_SIZE=$(find dist -type f -exec du -b {} + 2>/dev/null | awk '{sum += $1} END {print sum}' || echo "0")
if [ "$BUILD_SIZE" -gt "$MAX_SIZE" ]; then
  echo "‚ö†Ô∏è  Build size ($BUILD_SIZE bytes) exceeds recommended limit ($MAX_SIZE bytes)!" | tee -a project-check.log
else
  echo "‚úÖ Build size is within limits ($BUILD_SIZE bytes)." | tee -a project-check.log
fi

echo "üö¶ 4.2 Analyzing bundle for potential issues..." | tee -a project-check.log
if command -v npx >/dev/null 2>&1 && [ -d "dist/static/js" ]; then
  echo "‚ÑπÔ∏è  Bundle analysis available - consider running bundle analyzer manually if needed." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  Bundle analysis skipped." | tee -a project-check.log
fi

echo "üö¶ 5. Starting production preview (npm start)..." | tee -a project-check.log
npm start &
PREVIEW_PID=$!
sleep 10

echo "üîç Checking if production server responds at http://localhost:9003..." | tee -a project-check.log
if timeout 30 curl --silent --fail http://localhost:9003 >/dev/null; then
  echo "‚úÖ Production server responds!" | tee -a project-check.log
else
  echo "‚ùå Production server ŒîŒïŒù Œ±œÄŒ±ŒΩœÑŒ¨ŒµŒπ! ŒöŒ¨œÑŒπ œÑœÅŒ≠œáŒµŒπ..." | tee -a project-check.log
  kill $PREVIEW_PID || true
  exit 1
fi

echo "‚ÑπÔ∏è  ŒïŒªŒµŒ≥ŒæŒµ MANUAL œÉœÑŒøŒΩ browser œÉŒøœÖ Œ±ŒΩ œÜŒøœÅœÑœéŒΩŒµŒπ œÉœâœÉœÑŒ¨ œÉœÑŒø http://localhost:9003 (production mode)" | tee -a project-check.log
echo "‚ÑπÔ∏è  Œ†Œ¨œÑŒ∑œÉŒµ Enter œåœÑŒ±ŒΩ œÑŒµŒªŒµŒπœéœÉŒµŒπœÇ œÑŒø manual test (ŒÆ Ctrl+C Œ≥ŒπŒ± ŒΩŒ± œÑŒø Œ¥ŒπŒ±Œ∫œåœàŒµŒπœÇ Œ±ŒΩ Œ∫Œ¨œÑŒπ œÄŒ¨ŒµŒπ œÉœÑœÅŒ±Œ≤Œ¨)" | tee -a project-check.log
read -p "‚Ü©Ô∏è "

kill $PREVIEW_PID || true
sleep 2

echo "üö¶ 5.1 Running Firebase deploy dry-run..." | tee -a project-check.log
if ! firebase deploy --dry-run; then
  echo "‚ùå Firebase deploy dry-run failed. ŒîŒπœåœÅŒ∏œâœÉŒµ œÑŒ± œÉœÜŒ¨ŒªŒºŒ±œÑŒ±!" | tee -a project-check.log
  exit 1
fi
echo "‚úÖ Firebase deploy dry-run passed." | tee -a project-check.log

if [ -f package.json ] && grep -q "\"test\":" package.json; then
  echo "üö¶ 6. Running tests (npm test)..." | tee -a project-check.log
  if ! npm test; then
    echo "‚ùå Tests failed. ŒöŒ¨œÑŒπ Œ¥ŒµŒΩ œÄŒ¨ŒµŒπ Œ∫Œ±ŒªŒ¨!" | tee -a project-check.log
    exit 1
  fi
  echo "‚úÖ Tests passed." | tee -a project-check.log
else
  echo "‚ÑπÔ∏è  ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ tests, œÄœÅŒøœáœâœÅŒ¨ŒºŒµ." | tee -a project-check.log
fi

echo "üéâ ŒüŒõŒë ŒöŒëŒõŒë! Œ§œéœÅŒ± ŒºœÄŒøœÅŒµŒØœÇ ŒΩŒ± Œ∫Œ¨ŒΩŒµŒπœÇ deploy ŒºŒµ Œ±œÉœÜŒ¨ŒªŒµŒπŒ±!" | tee -a project-check.log
echo "Œ§ŒµŒªŒµŒØœâœÉŒµ: $(date)" | tee -a project-check.log